# GitLab CI/CD Pipeline for Observability Stack
# Simple deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE: docker:27.1.1-dind
  REGISTRY_LOGIN: docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

# GitLab CI/CD Variables configured:
# PRODUCTION_VM_IP - Production server IP address (protected)
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access (masked)
# REGISTRY_LOGIN - Registry login command for authentication (masked)
# PRODUCTION_DOMAIN - Production domain (protected/masked/expanded)
# PRODUCTION_HOST - Production hostname (protected)
# SECURE_GRAFANA_USERNAME - Grafana admin username (protected/masked)
# SECURE_GRAFANA_PASSWORD - Grafana admin password (protected/masked)
# SECURE_ACME_EMAIL - Email for SSL certificates (protected/masked/expanded)
# WEB_AUTH_USER - Basic auth username (protected/masked/expanded)
# WEB_AUTH_PASS - Basic auth password hash (protected/masked/expanded)
# SECURE_SLACK_WEBHOOK_URL - Slack webhook for notifications (protected/masked)

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Simple deployment to production server..."
    - echo "üîç Debug - PRODUCTION_VM_IP = ${PRODUCTION_VM_IP}"
    - export CI=true
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      ssh -o StrictHostKeyChecking=no -p 8090 root@${PRODUCTION_VM_IP} "
        echo 'Starting deployment...' &&
        mkdir -p /opt/services/monitoring &&
        cd /opt/services/monitoring &&
        
        echo 'Running registry login if provided...' &&
        eval \${REGISTRY_LOGIN:-true} &&
        
        echo 'üê≥ Docker login with CI token...' &&
        ${REGISTRY_LOGIN} &&
        
        echo 'üîç Checking if git repo exists...' &&
        if [ ! -d '.git' ]; then
          echo 'üì• Cloning repository...' &&
          git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/rahyar/monitoring.git .
        else
          echo 'ÔøΩ Pulling latest code...' &&
          git reset --hard &&
          git pull --force  
          

        fi &&
        
        echo 'üìÅ Going to observability stack directory...' &&
        cd observability/observability-full-stack &&
        
        echo '‚öôÔ∏è Installing required packages...' &&
        if ! command -v envsubst > /dev/null; then apt-get update && apt-get install -y gettext-base; fi &&
        
        echo 'üîß Updating environment variables from GitLab...' &&
        export VM_IP='$PRODUCTION_VM_IP' &&
        export DOMAIN_ADDRESS='$PRODUCTION_DOMAIN' &&
        export HOSTNAME='$PRODUCTION_HOST' &&
        export GRAFANA_USERNAME='$SECURE_GRAFANA_USERNAME' &&
        export GRAFANA_PASSWORD='$SECURE_GRAFANA_PASSWORD' &&
        export ACME_EMAIL='$SECURE_ACME_EMAIL' &&
        export WEB_AUTH_USER='$WEB_AUTH_USER' &&
        export WEB_AUTH_PASS='$WEB_AUTH_PASS' &&
        export SLACK_WEBHOOK_URL='$SECURE_SLACK_WEBHOOK_URL' &&
        
        echo 'üìù Generating environment file...' &&
        envsubst < .env.example > .env &&
        
        echo 'üê≥ Checking Docker installation...' &&
        if ! command -v docker > /dev/null; then echo 'Docker not found!' && exit 1; fi &&
        
        echo 'üì¶ Ensuring Docker Compose is available...' &&
        if ! command -v docker-compose > /dev/null; then 
          echo 'Installing Docker Compose...' &&
          curl -L \"https://github.com/docker/compose/releases/latest/download/docker-compose-\$(uname -s)-\$(uname -m)\" -o /usr/local/bin/docker-compose &&
          chmod +x /usr/local/bin/docker-compose
        fi &&
        
        echo 'üê≥ Restarting monitoring stack...' &&
        docker-compose down &&
        docker-compose pull &&
        docker-compose up -d &&
        
        echo '‚úÖ Deployment completed!' &&
        docker-compose ps
        "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
