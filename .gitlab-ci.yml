# GitLab CI/CD Pipeline for Observability Stack  
# Clean deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# GitLab CI/CD Variables needed:
# PRODUCTION_VM_IP - Production server IP address
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Deploying to production server..."
    - echo "ÔøΩ Preparing .env file from .env.example..."
    
    # Copy .env.example and replace with sed
    - cp observability/observability-full-stack/.env.example .env
    - echo "ÔøΩ Replacing variables with sed..."
    - sed -i "s/^VM_IP=VM_IP$/VM_IP=${PRODUCTION_VM_IP}/g" .env
    - sed -i "s/^DOMAIN_ADDRESS=DOMAIN_ADDRESS$/DOMAIN_ADDRESS=${PRODUCTION_DOMAIN}/g" .env  
    - sed -i "s/^HOSTNAME=observability-production$/HOSTNAME=${PRODUCTION_HOST}/g" .env
    - sed -i "s/^GRAFANA_USERNAME=GRAFANA_USERNAME$/GRAFANA_USERNAME=${SECURE_GRAFANA_USERNAME}/g" .env
    - sed -i "s/^GRAFANA_PASSWORD=GRAFANA_PASSWORD$/GRAFANA_PASSWORD=${SECURE_GRAFANA_PASSWORD}/g" .env
    - sed -i "s/^ACME_EMAIL=ACME_EMAIL$/ACME_EMAIL=${SECURE_ACME_EMAIL}/g" .env
    - sed -i "s/^WEB_AUTH_USER=WEB_AUTH_USER$/WEB_AUTH_USER=${WEB_AUTH_USER}/g" .env
    - sed -i "s/^WEB_AUTH_PASS=WEB_AUTH_PASS$/WEB_AUTH_PASS=${WEB_AUTH_PASS}/g" .env
    - sed -i "s|^SLACK_WEBHOOK_URL=SLACK_WEBHOOK_URL$|SLACK_WEBHOOK_URL=${SECURE_SLACK_WEBHOOK_URL}|g" .env
    
    - echo "‚úÖ .env file ready. Content preview:"
    - head -15 .env
    
    # SSH setup
    - echo "üîó Setting up SSH connection..."
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    
    # Copy .env file to server
    - echo "üì§ Copying .env file to server..."
    - scp -o StrictHostKeyChecking=no -P 8090 .env root@${PRODUCTION_VM_IP}:/tmp/monitoring.env
    
    # Deploy to server
    - echo "üöÄ Deploying to ${PRODUCTION_VM_IP}..."
    - |
      ssh -o StrictHostKeyChecking=no -p 8090 root@${PRODUCTION_VM_IP} "
        echo 'Starting deployment...' &&
        
        # Navigate to monitoring directory
        mkdir -p /opt/services/monitoring &&
        cd /opt/services/ &&
        
        # Clone or update repository
        if [ ! -d 'monitoring/.git' ]; then
          echo 'Cloning repository...' &&
          git clone git@git.erahyar.com:rahyar/monitoring.git
        else
          echo 'Updating repository...' &&
          cd monitoring &&
          git reset --hard &&
          git pull --force &&
          cd ..
        fi &&
        
        # Go to observability stack
        cd monitoring/observability/observability-full-stack &&
        
        # Copy the prepared .env file
        echo 'Using prepared .env file from GitLab CI...' &&
        cp /tmp/monitoring.env .env &&
        
        echo 'Verifying .env file content...' &&
        echo '=== .env file (first 15 lines) ===' &&
        head -15 .env &&
        echo '=== End of .env preview ===' &&
        
        echo 'Testing docker compose config...' &&
        if docker compose config --quiet; then
          echo 'Docker compose config is valid!' 
        else
          echo 'Docker compose config has issues:' &&
          docker compose config 2>&1 | head -10
        fi &&
        
        # Restart containers
        echo 'üê≥ Restarting monitoring stack...' &&
        docker compose down --remove-orphans &&
        docker compose pull &&
        docker compose up -d &&
        
        echo '‚úÖ Deployment completed!' &&
        docker compose ps
        "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
