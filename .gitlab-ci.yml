# GitLab CI/CD Pipeline for Observability Stack
# Simple deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# GitLab CI/CD Variables configured:
# PRODUCTION_VM_IP - Production server IP address (protected)
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access (masked)
# GITLAB_CI_TOKEN - GitLab CI token for private repo access (masked)
# PRODUCTION_DOMAIN - Production domain (protected/masked/expanded)
# PRODUCTION_HOST - Production hostname (protected)
# SECURE_GRAFANA_USERNAME - Grafana admin username (protected/masked)
# SECURE_GRAFANA_PASSWORD - Grafana admin password (protected/masked)
# SECURE_ACME_EMAIL - Email for SSL certificates (protected/masked/expanded)
# WEB_AUTH_USER - Basic auth username (protected/masked/expanded)
# WEB_AUTH_PASS - Basic auth password hash (protected/masked/expanded)
# SECURE_SLACK_WEBHOOK_URL - Slack webhook for notifications (protected/masked)

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Simple deployment to production server..."
    - echo "üîç Debug - PRODUCTION_VM_IP = ${PRODUCTION_VM_IP}"
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "üîç Testing SSH connectivity to ${PRODUCTION_VM_IP}:8090..."
    - timeout 10 nc -z $PRODUCTION_VM_IP 8090 || echo "‚ùå SSH port 8090 not reachable"
    - echo "üîç Adding SSH host key for port 8090..."
    - ssh-keyscan -p 8090 -H $PRODUCTION_VM_IP >> ~/.ssh/known_hosts || echo "StrictHostKeyChecking no" >> ~/.ssh/config
    - |
      ssh -p 8090 root@$PRODUCTION_VM_IP << EOF
        echo "üìÅ Setting up monitoring directory..."
        mkdir -p /opt/monitoring
        cd /opt/monitoring
        
        echo "üîç Configuring Git authentication..."
        git config --global credential.helper store
        echo "https://gitlab-ci-token:$GITLAB_CI_TOKEN@gitlab.com" > ~/.git-credentials
        
        echo "üîç Checking if git repo exists..."
        if [ ! -d ".git" ]; then
          echo "üì• Cloning repository with CI token..."
          git clone https://gitlab-ci-token:$GITLAB_CI_TOKEN@gitlab.com/rahyar/monitoring.git .
        else
          echo "üîÑ Pulling latest code with CI token..."
          git remote set-url origin https://gitlab-ci-token:$GITLAB_CI_TOKEN@gitlab.com/rahyar/monitoring.git
          git pull origin main
        fi
        
        echo "üìÅ Going to observability stack directory..."
        cd observability/observability-full-stack
        
        echo "‚öôÔ∏è Updating environment variables from GitLab..."
        # Install envsubst if not available
        if ! command -v envsubst &> /dev/null; then
          echo "üì¶ Installing gettext-base for envsubst..."
          apt-get update && apt-get install -y gettext-base
        fi
        
        # Export GitLab variables for envsubst
        export VM_IP="$PRODUCTION_VM_IP"
        export DOMAIN_ADDRESS="$PRODUCTION_DOMAIN"
        export HOSTNAME="$PRODUCTION_HOST"
        export GRAFANA_USERNAME="$SECURE_GRAFANA_USERNAME"
        export GRAFANA_PASSWORD="$SECURE_GRAFANA_PASSWORD"
        export ACME_EMAIL="$SECURE_ACME_EMAIL"
        export WEB_AUTH_USER="$WEB_AUTH_USER"
        export WEB_AUTH_PASS="$WEB_AUTH_PASS"
        export SLACK_WEBHOOK_URL="$SECURE_SLACK_WEBHOOK_URL"
        
        # Generate .env with GitLab variables
        envsubst < .env.example > .env
        
        echo "üê≥ Checking Docker and Docker Compose..."
        if ! command -v docker &> /dev/null; then
          echo "‚ùå Docker not installed. Please install Docker first!"
          exit 1
        fi
        
        if ! command -v docker-compose &> /dev/null; then
          echo "üì¶ Installing Docker Compose..."
          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
        fi
        
        echo "üê≥ Restarting containers..."
        docker-compose down
        docker-compose pull
        docker-compose up -d
        
        echo "‚úÖ Deployment completed!"
        docker-compose ps
      EOF
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
