# GitLab CI/CD Pipeline for Observability Stack  
# Clean deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# GitLab CI/CD Variables needed:
# PRODUCTION_VM_IP - Production server IP address
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Deploying to production server..."
    - echo "üîç Connecting to ${PRODUCTION_VM_IP}"
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      ssh -o StrictHostKeyChecking=no -p 8090 root@${PRODUCTION_VM_IP} "
        echo 'Starting deployment...' &&
        
        # Navigate to monitoring directory
        mkdir -p /opt/services/monitoring &&
        cd /opt/services/ &&
        
        # Clone or update repository
        if [ ! -d 'monitoring/.git' ]; then
          echo 'Cloning repository...' &&
          git clone git@git.erahyar.com:rahyar/monitoring.git
        else
          echo 'Updating repository...' &&
          cd monitoring &&
          git reset --hard &&
          git pull --force &&
          cd ..
        fi &&
        
        # Go to observability stack
        cd monitoring/observability/observability-full-stack &&
        
        # Create .env file and replace variables with sed
        echo 'Creating .env file from template...' &&
        cp .env.example .env &&
        
        echo 'üîç Debug: Checking GitLab CI variables...' &&
        echo \"PRODUCTION_VM_IP: '\${PRODUCTION_VM_IP}' (length: \${#PRODUCTION_VM_IP})\" &&
        echo \"PRODUCTION_DOMAIN: '\${PRODUCTION_DOMAIN}' (length: \${#PRODUCTION_DOMAIN})\" &&
        echo \"PRODUCTION_HOST: '\${PRODUCTION_HOST}' (length: \${#PRODUCTION_HOST})\" &&
        echo \"SECURE_GRAFANA_USERNAME: '\${SECURE_GRAFANA_USERNAME}' (length: \${#SECURE_GRAFANA_USERNAME})\" &&
        echo \"WEB_AUTH_USER: '\${WEB_AUTH_USER}' (length: \${#WEB_AUTH_USER})\" &&
        echo \"CI_COMMIT_BRANCH: '\${CI_COMMIT_BRANCH}'\" &&
        echo \"CI_ENVIRONMENT_NAME: '\${CI_ENVIRONMENT_NAME}'\" &&
        
        echo 'Setting fallback values for empty variables...' &&
        VM_IP_VAL=\${PRODUCTION_VM_IP:-192.168.80.25} &&
        DOMAIN_VAL=\${PRODUCTION_DOMAIN:-monlog.erahyar.com} &&
        HOST_VAL=\${PRODUCTION_HOST:-observability-production} &&
        GRAFANA_USER_VAL=\${SECURE_GRAFANA_USERNAME:-admin} &&
        GRAFANA_PASS_VAL=\${SECURE_GRAFANA_PASSWORD:-defaultpassword} &&
        ACME_EMAIL_VAL=\${SECURE_ACME_EMAIL:-admin@erahyar.com} &&
        WEB_USER_VAL=\${WEB_AUTH_USER:-admin} &&
        WEB_PASS_VAL=\${WEB_AUTH_PASS:-defaultpass} &&
        SLACK_URL_VAL=\${SECURE_SLACK_WEBHOOK_URL:-https://hooks.slack.com/services/DEFAULT/WEBHOOK} &&
        
        echo \"Using values: VM_IP=\$VM_IP_VAL, DOMAIN=\$DOMAIN_VAL, HOST=\$HOST_VAL\" &&
        
        echo 'Replacing variables with values (GitLab CI or fallbacks)...' &&
        sed -i \"s/^VM_IP=VM_IP\\\$/VM_IP=\$VM_IP_VAL/g\" .env &&
        sed -i \"s/^DOMAIN_ADDRESS=DOMAIN_ADDRESS\\\$/DOMAIN_ADDRESS=\$DOMAIN_VAL/g\" .env &&
        sed -i \"s/^HOSTNAME=observability-production\\\$/HOSTNAME=\$HOST_VAL/g\" .env &&
        sed -i \"s/^GRAFANA_USERNAME=GRAFANA_USERNAME\\\$/GRAFANA_USERNAME=\$GRAFANA_USER_VAL/g\" .env &&
        sed -i \"s/^GRAFANA_PASSWORD=GRAFANA_PASSWORD\\\$/GRAFANA_PASSWORD=\$GRAFANA_PASS_VAL/g\" .env &&
        sed -i \"s/^ACME_EMAIL=ACME_EMAIL\\\$/ACME_EMAIL=\$ACME_EMAIL_VAL/g\" .env &&
        sed -i \"s/^WEB_AUTH_USER=WEB_AUTH_USER\\\$/WEB_AUTH_USER=\$WEB_USER_VAL/g\" .env &&
        sed -i \"s/^WEB_AUTH_PASS=WEB_AUTH_PASS\\\$/WEB_AUTH_PASS=\$WEB_PASS_VAL/g\" .env &&
        sed -i \"s|^SLACK_WEBHOOK_URL=SLACK_WEBHOOK_URL\\\$|SLACK_WEBHOOK_URL=\$SLACK_URL_VAL|g\" .env &&
        
        echo 'Checking .env file after sed replacements...' &&
        echo '=== Key variables in .env ===' &&
        grep -E '^(VM_IP|DOMAIN_ADDRESS|HOSTNAME|GRAFANA_USERNAME|GRAFANA_PASSWORD|ACME_EMAIL|WEB_AUTH_USER|WEB_AUTH_PASS|SLACK_WEBHOOK_URL)=' .env &&
        echo '=== End of key variables ===' &&
        
        echo 'Testing docker-compose config...' &&
        if docker-compose config --quiet; then
          echo 'Docker compose config is valid!' 
        else
          echo 'Docker compose config has issues - checking for undefined variables...' &&
          docker-compose config 2>&1 | head -20
        fi &&
        
        echo 'Environment variables updated successfully!' &&
        
        # Restart containers
        echo 'üê≥ Restarting monitoring stack...' &&
        docker-compose down --remove-orphans &&
        docker-compose pull &&
        docker-compose up -d &&
        
        echo '‚úÖ Deployment completed!' &&
        docker-compose ps
        "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
