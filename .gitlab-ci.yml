# GitLab CI/CD Pipeline for Observability Stack
# Simple deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# GitLab CI/CD Variables configured:
# PRODUCTION_VM_IP - Production server IP address (protected)
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access (masked)
# REGISTRY_LOGIN - Registry login token for private repo access (masked) - PRIMARY
# GITLAB_CI_TOKEN - GitLab CI token for private repo access (masked) - OPTIONAL
# DEPLOY_TOKEN_USERNAME - Deploy token username (masked) - OPTIONAL  
# DEPLOY_TOKEN_PASSWORD - Deploy token password (masked) - OPTIONAL
# PRODUCTION_DOMAIN - Production domain (protected/masked/expanded)
# PRODUCTION_HOST - Production hostname (protected)
# SECURE_GRAFANA_USERNAME - Grafana admin username (protected/masked)
# SECURE_GRAFANA_PASSWORD - Grafana admin password (protected/masked)
# SECURE_ACME_EMAIL - Email for SSL certificates (protected/masked/expanded)
# WEB_AUTH_USER - Basic auth username (protected/masked/expanded)
# WEB_AUTH_PASS - Basic auth password hash (protected/masked/expanded)
# SECURE_SLACK_WEBHOOK_URL - Slack webhook for notifications (protected/masked)

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Simple deployment to production server..."
    - echo "üîç Debug - PRODUCTION_VM_IP = ${PRODUCTION_VM_IP}"
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "üîç Testing SSH connectivity to ${PRODUCTION_VM_IP}:8090..."
    - timeout 10 nc -z $PRODUCTION_VM_IP 8090 || echo "‚ùå SSH port 8090 not reachable"
    - echo "üîç Adding SSH host key for port 8090..."
    - ssh-keyscan -p 8090 -H $PRODUCTION_VM_IP >> ~/.ssh/known_hosts || echo "StrictHostKeyChecking no" >> ~/.ssh/config
    - |
      ssh -p 8090 root@$PRODUCTION_VM_IP << EOF
        echo "üìÅ Setting up monitoring directory..."
        mkdir -p /opt/monitoring
        cd /opt/monitoring
        
        echo "üîç Configuring Git authentication (trying multiple methods)..."
        
        # Method 1: Try with built-in CI_JOB_TOKEN
        if [ ! -d ".git" ]; then
          echo "üì• Method 1: Cloning with CI_JOB_TOKEN..."
          git clone https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/rahyar/monitoring.git . || echo "Method 1 failed"
        fi
        
        # Method 2: Try with custom GITLAB_CI_TOKEN if Method 1 failed
        if [ ! -d ".git" ] && [ -n "$GITLAB_CI_TOKEN" ]; then
          echo "üì• Method 2: Cloning with GITLAB_CI_TOKEN..."
          git clone https://gitlab-ci-token:$GITLAB_CI_TOKEN@gitlab.com/rahyar/monitoring.git . || echo "Method 2 failed"
        fi
        
        # Method 3: Try with REGISTRY_LOGIN if available
        if [ ! -d ".git" ] && [ -n "$REGISTRY_LOGIN" ]; then
          echo "üì• Method 3: Cloning with REGISTRY_LOGIN..."
          git clone https://gitlab-ci-token:$REGISTRY_LOGIN@gitlab.com/rahyar/monitoring.git . || echo "Method 3 failed"
        fi
        
        # Method 4: Try with Deploy Token if others failed
        if [ ! -d ".git" ] && [ -n "$DEPLOY_TOKEN_USERNAME" ] && [ -n "$DEPLOY_TOKEN_PASSWORD" ]; then
          echo "üì• Method 4: Cloning with Deploy Token..."
          git clone https://$DEPLOY_TOKEN_USERNAME:$DEPLOY_TOKEN_PASSWORD@gitlab.com/rahyar/monitoring.git . || echo "Method 4 failed"
        fi
        
        # Method 5: Fallback to public clone if all methods failed
        if [ ! -d ".git" ]; then
          echo "‚ö†Ô∏è  All authentication methods failed. Trying public clone..."
          git clone https://gitlab.com/rahyar/monitoring.git . || echo "‚ùå All clone methods failed!"
        fi
        
        # Validate that we have the repo
        if [ ! -d ".git" ]; then
          echo "üí• FATAL: Could not clone repository. Check authentication tokens!"
          exit 1
        else
          echo "‚úÖ Repository successfully available"
        fi
        
        # If repo exists, just pull
        if [ -d ".git" ]; then
          echo "üîÑ Pulling latest code..."
          # Try different authentication methods for pull
          git pull origin main || \
          (git remote set-url origin https://gitlab-ci-token:$CI_JOB_TOKEN@gitlab.com/rahyar/monitoring.git && git pull origin main) || \
          (git remote set-url origin https://gitlab-ci-token:$REGISTRY_LOGIN@gitlab.com/rahyar/monitoring.git && git pull origin main) || \
          (git remote set-url origin https://gitlab-ci-token:$GITLAB_CI_TOKEN@gitlab.com/rahyar/monitoring.git && git pull origin main) || \
          echo "All pull methods failed"
        fi
        
        echo "üìÅ Going to observability stack directory..."
        cd observability/observability-full-stack
        
        echo "‚öôÔ∏è Updating environment variables from GitLab..."
        # Install envsubst if not available
        if ! command -v envsubst &> /dev/null; then
          echo "üì¶ Installing gettext-base for envsubst..."
          apt-get update && apt-get install -y gettext-base
        fi
        
        # Export GitLab variables for envsubst
        export VM_IP="$PRODUCTION_VM_IP"
        export DOMAIN_ADDRESS="$PRODUCTION_DOMAIN"
        export HOSTNAME="$PRODUCTION_HOST"
        export GRAFANA_USERNAME="$SECURE_GRAFANA_USERNAME"
        export GRAFANA_PASSWORD="$SECURE_GRAFANA_PASSWORD"
        export ACME_EMAIL="$SECURE_ACME_EMAIL"
        export WEB_AUTH_USER="$WEB_AUTH_USER"
        export WEB_AUTH_PASS="$WEB_AUTH_PASS"
        export SLACK_WEBHOOK_URL="$SECURE_SLACK_WEBHOOK_URL"
        
        # Generate .env with GitLab variables
        envsubst < .env.example > .env
        
        echo "üê≥ Checking Docker and Docker Compose..."
        if ! command -v docker &> /dev/null; then
          echo "‚ùå Docker not installed. Please install Docker first!"
          exit 1
        fi
        
        if ! command -v docker-compose &> /dev/null; then
          echo "üì¶ Installing Docker Compose..."
          curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
        fi
        
        echo "üê≥ Restarting containers..."
        docker-compose down
        docker-compose pull
        docker-compose up -d
        
        echo "‚úÖ Deployment completed!"
        docker-compose ps
      EOF
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
