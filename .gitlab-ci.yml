# GitLab CI/CD Pipeline for Observability Stack
# Simple deployment: pull code and restart containers

stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_IMAGE: docker:27.1.1-dind
  REGISTRY_LOGIN: docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY

# GitLab CI/CD Variables configured:
# PRODUCTION_VM_IP - Production server IP address (protected)
# SSH_PRIVATE_KEY_RUNNER - SSH private key for server access (masked)
# REGISTRY_LOGIN - Registry login command for authentication (masked)
# PRODUCTION_DOMAIN - Production domain (protected/masked/expanded)
# PRODUCTION_HOST - Production hostname (protected)
# SECURE_GRAFANA_USERNAME - Grafana admin username (protected/masked)
# SECURE_GRAFANA_PASSWORD - Grafana admin password (protected/masked)
# SECURE_ACME_EMAIL - Email for SSL certificates (protected/masked/expanded)
# WEB_AUTH_USER - Basic auth username (protected/masked/expanded)
# WEB_AUTH_PASS - Basic auth password hash (protected/masked/expanded)
# SECURE_SLACK_WEBHOOK_URL - Slack webhook for notifications (protected/masked)

default:
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client netcat-openbsd

deploy:production:
  stage: deploy
  script:
    - echo "üöÄ Simple deployment to production server..."
    - echo "üîç Debug - PRODUCTION_VM_IP = ${PRODUCTION_VM_IP}"
    - export CI=true
    - 'command -v ssh-agent >/dev/null || ( apk add --no-cache openssh-client )'
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY_RUNNER" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - |
      ssh -o StrictHostKeyChecking=no -p 8090 root@${PRODUCTION_VM_IP} "
        echo 'Starting deployment...' &&
        mkdir -p /opt/services/monitoring &&
        cd /opt/services/ &&
        echo 'Checking git repository...' &&
        if [ ! -d "monitoring/.git" ]; then
          echo 'Cloning repository...' &&
          git clone git@git.erahyar.com:rahyar/monitoring.git
        fi &&
        if [ -d "monitoring/.git" ]; then
          echo 'Updating repository...' &&
          cd monitoring &&
          git reset --hard &&
          git pull --force
        fi &&

        echo 'üìÅ Going to observability stack directory...' &&
        cd observability/observability-full-stack &&
        echo 'üìù Generating environment file with sed...' &&
        echo 'Debug: Checking GitLab variables:' &&
        echo \"PRODUCTION_VM_IP = \$PRODUCTION_VM_IP\" &&
        echo \"PRODUCTION_DOMAIN = \$PRODUCTION_DOMAIN\" &&
        echo \"PRODUCTION_HOST = \$PRODUCTION_HOST\" &&
        
        echo 'Setting fallback values for empty variables...' &&
        VM_IP_VALUE=\${PRODUCTION_VM_IP:-192.168.80.25} &&
        DOMAIN_VALUE=\${PRODUCTION_DOMAIN:-monlog.erahyar.com} &&
        HOST_VALUE=\${PRODUCTION_HOST:-observability-production} &&
        
        echo \"Using values: VM_IP=\$VM_IP_VALUE, DOMAIN=\$DOMAIN_VALUE, HOST=\$HOST_VALUE\" &&
        
        cp .env.example .env &&
        echo 'Starting sed replacements...' &&
        echo 'Setting up authentication variables with fallbacks...' &&
        GRAFANA_USER_VALUE=\${SECURE_GRAFANA_USERNAME:-admin} &&
        GRAFANA_PASS_VALUE=\${SECURE_GRAFANA_PASSWORD:-secure_password_here} &&
        ACME_EMAIL_VALUE=\${SECURE_ACME_EMAIL:-admin@erahyar.com} &&
        WEB_USER_VALUE=\${WEB_AUTH_USER:-admin} &&
        WEB_PASS_VALUE=\${WEB_AUTH_PASS:-\\\$2y\\\$10\\\$defaulthash123456789012345678901} &&
        SLACK_URL_VALUE=\${SECURE_SLACK_WEBHOOK_URL:-https://hooks.slack.com/services/DEFAULT/WEBHOOK/URL} &&
        
        echo \"Debug - Final values:\" &&
        echo \"GRAFANA_USER=\$GRAFANA_USER_VALUE\" &&
        echo \"ACME_EMAIL=\$ACME_EMAIL_VALUE\" &&
        echo \"WEB_USER=\$WEB_USER_VALUE\" &&
        
        echo 'Replacing variables in .env file...' &&
        sed -i \"s/^VM_IP=VM_IP\\\$/VM_IP=\$VM_IP_VALUE/g\" .env &&
        sed -i \"s/^DOMAIN_ADDRESS=DOMAIN_ADDRESS\\\$/DOMAIN_ADDRESS=\$DOMAIN_VALUE/g\" .env &&
        sed -i \"s/^HOSTNAME=observability-production\\\$/HOSTNAME=\$HOST_VALUE/g\" .env &&
        sed -i \"s/^GRAFANA_USERNAME=GRAFANA_USERNAME\\\$/GRAFANA_USERNAME=\$GRAFANA_USER_VALUE/g\" .env &&
        sed -i \"s/^GRAFANA_PASSWORD=GRAFANA_PASSWORD\\\$/GRAFANA_PASSWORD=\$GRAFANA_PASS_VALUE/g\" .env &&
        sed -i \"s/^ACME_EMAIL=ACME_EMAIL\\\$/ACME_EMAIL=\$ACME_EMAIL_VALUE/g\" .env &&
        sed -i \"s/^WEB_AUTH_USER=WEB_AUTH_USER\\\$/WEB_AUTH_USER=\$WEB_USER_VALUE/g\" .env &&
        sed -i \"s/^WEB_AUTH_PASS=WEB_AUTH_PASS\\\$/WEB_AUTH_PASS=\$WEB_PASS_VALUE/g\" .env &&
        sed -i \"s|^SLACK_WEBHOOK_URL=SLACK_WEBHOOK_URL\\\$|SLACK_WEBHOOK_URL=\$SLACK_URL_VALUE|g\" .env &&
        
        echo 'Verifying .env file after replacements...' &&
        echo '=== .env content (first 20 lines) ===' &&
        head -20 .env &&
        echo '=== End of .env content ===' &&
        
        echo 'Checking for any remaining placeholder values...' &&
        if grep -E '=(GRAFANA_USERNAME|GRAFANA_PASSWORD|VM_IP|DOMAIN_ADDRESS|ACME_EMAIL|WEB_AUTH_USER|WEB_AUTH_PASS|SLACK_WEBHOOK_URL)$' .env; then
          echo 'WARNING: Found unreplaced placeholder values!' &&
          exit 1
        fi &&
        echo 'All placeholder values successfully replaced!' &&
        
        echo 'Checking for undefined variables in compose files...' &&
        docker-compose config --quiet || echo 'Warning: compose config check failed' &&
        
        echo 'üê≥ Restarting monitoring stack...' &&
        docker-compose down &&
        docker-compose pull &&
        docker-compose up -d &&
        
        echo '‚úÖ Deployment completed!' &&
        docker-compose ps
        "
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
