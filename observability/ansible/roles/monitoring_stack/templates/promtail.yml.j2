server:
  http_listen_port: {{ monitoring_promtail_http_listen_port }}
  grpc_listen_port: 0

positions:
  filename: {{ monitoring_promtail_positions_file }}

clients:
  - url: {{ monitoring_loki_push_url | quote }}

scrape_configs:
  - job_name: system
    static_configs:
{% for p in monitoring_promtail_system_paths %}
      - targets:
          - localhost
        labels:
          job: {{ monitoring_promtail_system_job | quote }}
          host: {{ inventory_hostname | quote }}
          instance: {{ inventory_hostname | quote }}
          __path__: {{ p | quote }}
{% endfor %}

  - job_name: container
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      - source_labels: ["__meta_docker_container_name"]
        regex: "/(.*)"
        target_label: {{ monitoring_promtail_container_label | quote }}
    static_configs:
      - targets:
          - localhost
        labels:
          host: {{ inventory_hostname | quote }}
          instance: {{ inventory_hostname | quote }}
{% if monitoring_promtail_container_pipeline | default(false) %}
    pipeline_stages:
{{ monitoring_promtail_container_pipeline | indent(6, true) }}
{% endif %}
